map $http_x_forwarded_for $real_client_ip {
    ~^(\d+\.\d+\.\d+\.\d+) $1;
    default $http_cf_connecting_ip;
}

map $sent_http_content_type $expires {
    "text/html"                 epoch;
    "text/html; charset=utf-8"  epoch;
    default                     off;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

map $http_x_use_docker $php_backend {
    default  laravel_php:9000;
}

map $http_x_use_docker $api_socket {
    default  "http://45.137.212.30:8443";
}

map $http_x_use_docker $root_path {
    '1'  "/var/www/html";
    default  "/var/www/html";
}

map $http_x_use_docker $root_public_path {
    '1'  "/var/www/html/public";
    default  "/var/www/html/public";
}


map $http_x_forwarded_for $allowed_ip {
    default 0;
    "45.137.212.30" 1;
    "212.112.118.37" 1;
    "195.2.76.252"   1;
    "31.172.78.221"  1;
    "195.20.119.68"  1;
    "186.2.160.57"   1;
    "116.202.228.225"  1;
    "35.159.146.42"   1;
    "94.198.216.37"   1;
    "51.250.54.238"   1;
    "51.250.25.122"   1;
    "116.203.217.0"   1;
    "168.119.157.136"   1;
    "168.119.60.227"   1;
    "138.201.88.124"   1;
    "109.195.19.45"    1;
    "178.154.197.79"   1;
    "159.89.25.81"     1;
    "165.227.159.246"  1;
    "157.245.17.198"   1;
    "68.183.213.224"   1;
    "37.212.84.57"     1;
}

map $time_iso8601 $formatted_time {
    "~^(?<year>\d{4})-(?<month>\d{2})-(?<day>\d{2})T(?<hour>\d{2}):(?<minute>\d{2}):(?<second>\d{2})" $hour:$minute:$second;
}

map $real_client_ip $limited_ip {
    default "";
    "~*^(?P<octet1>[0-9]+)\.(?P<octet2>[0-9]+)\.(?P<octet3>[0-9]+)\.(?P<octet4>[0-9]+)$" $real_client_ip;
}

limit_conn_zone $real_client_ip zone=api_conn:20m;
limit_req_zone $real_client_ip zone=api_req:20m rate=40r/s;

log_format custom_log_format '$real_client_ip [$formatted_time] "$request" $status $msec $body_bytes_sent "$request_uri" "$http_user_agent"';

map $status $loggable {
    522     0;
    default 1;
}

limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;

server {
    listen 80;
    server_name stref.win www.stref.win;
    return 301 https://stimule1.win$request_uri;
}

server {
    listen 80;
    server_name stimule.win;

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/stimule.win/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/stimule.win/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    return 301 https://stimule1.win$request_uri;
}

server {
    listen 80;
    server_name stml.win;

    # Указываем DNS-резолвер (например, Google DNS или Cloudflare DNS)
    resolver 8.8.8.8 1.1.1.1 valid=30s;

    # Проксирование только VK callback
    location = /auth/vkontakte/handle {
	 return 301 https://stimule1.win/auth/vkontakte/handle$is_args$args;
}

    # Для всех остальных запросов — 404 (или другая "заглушка")
    location / {
        return 404;  # Скрываем связь с stimule1.win
        # Альтернатива: можно вернуть пустую страницу с 200 OK
        # add_header Content-Type text/plain;
        # return 200 '';
    }
}

server {
    listen 80;
    server_name 45.137.212.30;

    # Только для разрешённых IP (дублируем список из основного конфига)

    allow 159.89.25.81;
    allow 165.227.159.246;
    allow 157.245.17.198;
    allow 68.183.213.224;

    allow 51.250.54.238;
    allow 51.250.25.122;
    allow 116.203.217.0;
    allow 168.119.157.136;
    allow 168.119.60.227;
    allow 138.201.88.124;
    allow 178.154.197.79;
        allow 116.202.228.225;
        allow 35.159.146.42;
        allow 94.198.216.37;
        allow 186.2.160.57/32;
        allow 109.236.93.25/32;
        allow 77.220.207.0/24;
        allow 45.10.240.0/24;
        allow 45.10.241.0/24;
        allow 45.10.242.0/24;
        allow 186.2.160.0/24;
        allow 186.2.164.0/24;
        allow 186.2.167.0/24;
        allow 186.2.168.0/24;
        allow 185.178.209.197/32;
        allow 190.115.30.44/32;
        allow 168.119.157.136/32;
        allow 168.119.60.227/32;
        allow 178.154.197.79/32;
        allow 116.203.217.0/32;
        allow 51.250.25.122/32;
        allow 185.177.127.13;
        allow 121.127.46.166;
        allow 109.195.19.45;
        allow 207.154.235.84;
        allow 46.101.152.230;

        allow 185.177.127.13;
        allow 109.236.93.25;
        allow 165.227.159.246;
        allow 157.245.17.198;
        allow 68.183.213.224;

        allow 35.154.160.0;
        allow 13.127.118.239;
        allow 13.233.1.186;
        allow 13.235.127.79;
        allow 3.111.193.74;
	allow 188.166.21.18;
        allow 45.137.212.30;
    # ... остальные IP ...
    deny all;

    root $root_public_path;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass $php_backend;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
}

    access_log /var/log/nginx/ip-access.log;
    error_log /var/log/nginx/ip-error.log;
}

server {
    # Log files for Debugging
    access_log /var/log/nginx/laravel-access.log;
    error_log /var/log/nginx/laravel-error.log;

    gzip on;
    gzip_static on; # allows serving pre-compressed files
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Webroot Directory for Laravel project
    root $root_public_path;
    index index.php index.html index.htm;

    # Your Domain Name
    server_name stimule1.win;


    location ^~ /.well-known/acme-challenge/ {
        root $root_path;
        allow all;
    }

    location = /tech.html {
        # Можно добавить кастомные заголовки, логирование и т.д.
        # Или просто оставить пустым, чтобы отдавалась страница
    }

    location / {
        limit_req zone=api_req burst=40 nodelay;
        limit_conn api_conn 20;
        limit_req_status 503;

        # return 302 /tech.html;

        #   if ($allowed_ip = 0) {
        #       return 403;
        #   }

        allow 116.202.228.225;
        allow 35.159.146.42;
        allow 94.198.216.37;

        allow 159.89.25.81;
        allow 165.227.159.246;
        allow 157.245.17.198;
        allow 68.183.213.224;

        allow 186.2.160.57/32;
        allow 188.166.21.18;
        allow 77.220.207.0/24;
        allow 45.10.240.0/24;
        allow 45.10.241.0/24;
        allow 45.10.242.0/24;
        allow 186.2.160.0/24;
        allow 186.2.164.0/24;
        allow 186.2.167.0/24;
        allow 186.2.168.0/24;
        allow 185.178.209.197/32;
        allow 190.115.30.44/32;
        allow 168.119.157.136/32;
        allow 168.119.60.227/32;
        allow 178.154.197.79/32;
        allow 116.203.217.0/32;
        allow 51.250.25.122/32;
        allow 185.177.127.13;
        allow 121.127.46.166;
        allow 207.154.235.84;
        allow 46.101.152.230;

        allow 185.177.127.13;
        allow 109.236.93.25;
        allow 165.227.159.246;
        allow 157.245.17.198;
        allow 68.183.213.224;

        allow 35.154.160.0;
        allow 13.127.118.239;
        allow 13.233.1.186;
        allow 13.235.127.79;
        allow 3.111.193.74;
        allow 45.137.212.30;

        allow 77.220.207.0/24;
        allow 45.10.240.0/24;
        allow 45.10.241.0/24;
        allow 45.10.242.0/24;
        allow 186.2.160.0/24;
        allow 186.2.164.0/24;
        allow 186.2.167.0/24;
        allow 186.2.168.0/24;
        allow 185.178.209.197/32;
        allow 190.115.30.44/32;
        allow 185.178.208.153/32;

        allow 51.250.54.238;
        allow 51.250.25.122;
        allow 116.203.217.0;
        allow 168.119.157.136;
        allow 168.119.60.227;
        allow 138.201.88.124;
        allow 178.154.197.79;

        # Запретите доступ для всех остальных IP-адресов
        deny all;

        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP-FPM Configuration Nginx
    location ~ \.php$ {
        # error_page 503 /tech.html;
        # return 503;

    try_files $uri =404;
         fastcgi_split_path_info ^(.+\.php)(/.+)$;
         fastcgi_pass $php_backend;
         fastcgi_index index.php;
         fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
         include fastcgi_params;
    }

    location /socket.io {
        proxy_pass $api_socket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    client_body_timeout 15s;
    client_header_timeout 15s;

    client_header_buffer_size 8k;
    client_max_body_size 512k;

    location ~ /\.ht {
        deny all;
    }


    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/stimule1.win/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/stimule1.win/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}


server {
    if ($host = stimule1.win) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    server_name stimule1.win;
    listen 80;
    return 404; # managed by Certbot

}


server {
    if ($host = stimule.win) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    server_name stimule.win;
    listen 80;
    return 404; # managed by Certbot

}